<!DOCTYPE html>
<html>

<head profile="http://www.w3.org/2005/10/profile"> 
  
  <link rel="icon" type="image/png" href="http://example.com/myicon.png">

  <meta charset="utf-8" />
  <!-- 
    viewport(반응형 웹) :  여러 디스플레이 통해 접속 가능 
    width=device-width : 페이지 너비를 기기의 스크린 너비로 설정
    initial-scale=1 : 페이지 로딩 시 원래 크기를 사용 (확대, 축소 되지 않음)
  -->
  <!--for messagebox-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>D.I.Y</title>
  <!-- Blockly 개발자모드 코드 안보이게 막음-->
  <!-- <script type="text/javascript">
    console = {};
    console.log = function(){};
    console.warn = function(){};
    console.error = function(){};
    console.info = function(){}; 
  </script>  -->

  <!-- #####################################################################################################  -->
  <!-- ******************************               CDN                       ******************************* -->
  <!-- #####################################################################################################  -->
  <!-- jquery --> 
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
  <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
  <!-- tensorflow -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"> </script>
  
  <!-- blockly-->
  <script src="/js/blockly/storage.js"></script>
  <script src="/js/blockly/brython.js"></script>
  <script src="/js/blockly/brython_stdlib.js"></script>
  <script src="https://unpkg.com/prop-types@15.6/prop-types.js"></script>
  
  <!-- plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>    
  
  <!--numjs-->             
  <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>  
  
  <!-- pyodide cdn변경 20.11.16 -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.16.1/full/pyodide.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/pyodide/v0.15.0/full/pyodide.js"></script> -->

  <!-- <script src="http://inhatc.iptime.org:4519/pyodide.js"></script>  -->

  <!-- 기태 처리 (파일) 21.01.06------------------------------------------------------------------------->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/BrowserFS/2.0.0/browserfs.min.js"></script>

  <!--   javascript 언어 규칙 및 블록 변환과 관련된 내용을 압축한 파일 -->
  <script src="/js/blockly/blockly_compressed.js"></script>
  <script src="/js/blockly/javascript_compressed.js"></script>
  <script src="/js/blockly/python_compressed.js"></script>
  <script src="/js/blockly/blocks_compressed.js"></script>
  
  <!--미리 정의되어 있는 기본 블록에 대한 설정을 모두 담고 있음.-->
  <script src="/js/blockly/block_pyodide.js"></script>

  <!-- codemirror 추가 -->
  <script src="/js/codemirror/lib/codemirror.js"></script>
  <!-- rel: 현재 문서와 외부 리소스 사이의 연관 관계 명시 / stylesheet: 스타일 시트로 사용할 외부 리소스 불러옴-->
  <link rel="stylesheet" href="/js/codemirror/lib/codemirror.css">
  <script src="/js/codemirror/mode/javascript/javascript.js"></script>
  <script src="/js/codemirror/mode/python/python.js"></script>
  <!-- codemirror 추가 -->

  <!-- codemirror 스타일 지정 -->
  <link rel="stylesheet" href="./js/codemirror/theme/oceanic-next.css">
  <!-- codemirror 스타일 지정 -->

  <!-- cdoemirror 자동 완성 기능 -->
  <script src="./js/codemirror/addon/hint/show-hint.js"></script>
  <script src="./js/codemirror/addon/hint/javascript-hint.js"></script>
  <script src="./js/codemirror/addon/hint/anyword-hint.js"></script>
  <link rel="stylesheet" href="./js/codemirror/addon/hint/show-hint.css">
  <!-- cdoemirror 자동 완성 기능 -->

  <!-- 그림판자리 canvas -->
  <script src="/js/canvas.js"></script>
  <!-- 블록, 블록+코드, 코드 변경-->
  <script src="/js/tabDisplay.js"></script>
  <!-- 그래프 aside -->
  <script src="/js/aside.js"></script>

  <!--messageBox-->
  <script src="./js/blockly/messagebox/messagebox.js"></script>
  <link href="./js/blockly/messagebox/messagebox.css" rel="stylesheet" type="text/css">

  <script>setCookie("download_block","", 1);</script>

  <!-- #####################################################################################################  -->
  <!-- ******************************              블록 import                ******************************* -->
  <!-- #####################################################################################################  -->
  <script src=/js/script.js></script>

  
  <!-- #####################################################################################################  -->
  <!-- ******************************                CSS                      ******************************* -->
  <!-- #####################################################################################################  -->

  <!-- 사이드 바 -->
  <link rel="stylesheet" href="/css/sidebar.css">
  
  <!-- table --> 
  <link rel="stylesheet" href="/css/table_custom.css">
  
  <!-- 기본 css -->
  <link rel="stylesheet" href="/css/basic.css">

  <!-- 명성이형 파일 불러올때 필요한 변수설정 
  <script>
    var Data_process_on = 0;
    var DL_Gra = 0;
    var testing_1 = 0;
  </script>
  명성이형 파일 불러올때 필요한 변수설정 -->
  <!-- 하단 변수가 없는 경우 맷플롯립에서 문제가 발생함 삭제 및 주석 금지 -->
  <script>var DL_Gra = 0;</script>
  <!-- plotly 데이터 시각화를 위해 필요-->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="./js/utils/plotly.js"></script>
  <!-- plotly -->

  <!-- 이거 중복되는 거임 필요없을거같기도함. -->
  <!-- 플러그인 로딩이 끝났을때 .then => languagePluginLoader: 비동기 객체 -->
  <!-- , 'CLAPACK', 'Jinja2', 
                           'MarkupSafe', 'Pygments', 'asciitree', 'astropy', 'atomicwrites', 'attrs', 'autograd', 'beautifulsoup4', 
                           'biopython', 'bleach', 'cloudpickle', 'cssselect', 'cycler', 'cytoolz', 'decorator', 'distlib', 'docutils', 
                           'freesasa', 'future', 'glpk', 'html5lib', 'imageio', 'jedi', 'joblib', 'kiwisolver', 'libiconv', 'libxml', 
                           'libxslt', 'lxml', 'mne', 'more-itertools', 'mpmath', 'msgpack', 'networkx', 'nlopt', 'nltk', 'nose', 
                           'numcodecs', 'optlang', 'packaging', 'parso', 'patsy', 'pillow', 'pluggy', 'py', 'pyodide-interrupts', 
                           'pyparsing', 'pytest', 'python-dateutil', 'python-sat', 'pytz', 'pywavelets', 'regex', 'scipy', 'setuptools', 
                           'six', 'soupsieve', 'statsmodels', 'swiglpk', 'sympy', 'toolz', 'traits', 'uncertainties', 'webencodings', 'xlrd', 'yt', 'zarr', 'zlib'-->
  <!-- <script>
    languagePluginLoader.then(() => {
      // 패키지로드 loadpackage, micropip은 pydodie에서 파이썬 wheel에 관련하여 설치함.
      pyodide.loadPackage(['pandas', 'numpy', 'matplotlib', 'scikit-learn', 'scikit-image', 'micropip', 'CLAPACK', 'Jinja2', 
                           'MarkupSafe', 'Pygments', 'asciitree', 'astropy', 'atomicwrites', 'attrs', 'autograd', 'beautifulsoup4', 
                           'biopython', 'bleach', 'cloudpickle', 'cssselect', 'cycler', 'cytoolz', 'decorator', 'distlib', 'docutils', 
                           'freesasa', 'future', 'glpk', 'html5lib', 'imageio', 'jedi', 'joblib', 'kiwisolver', 'libiconv', 'libxml', 
                           'libxslt', 'lxml', 'mne', 'more-itertools', 'mpmath', 'msgpack', 'networkx', 'nlopt', 'nltk', 'nose', 
                           'numcodecs', 'optlang', 'packaging', 'parso', 'patsy', 'pillow', 'pluggy', 'py', 'pyodide-interrupts', 
                           'pyparsing', 'pytest', 'python-dateutil', 'python-sat', 'pytz', 'pywavelets', 'regex', 'scipy', 'setuptools', 
                           'six', 'soupsieve', 'statsmodels', 'swiglpk', 'sympy', 'toolz', 'traits', 'uncertainties', 'webencodings', 'xlrd', 'yt', 'zarr', 'zlib']).then(
      () => { 
        console.log('pyodide 라이브러리 로딩완료');
        $("#loading_image1").hide(); // 홈페이지 로딩 끝나면 로딩 이미지 없앰 
        $("#runButton1").css({
          'display': "block"
        });
        $("#loading_image2").hide(); // 그래프 로딩 끝나면 로딩 창 없앰 
        $("#runButton2").css({
          'display': "inline"
        });
      });
    });
  </script> -->
  <!--Socket.IO 지금은 안쓰는데... --> 
  <!-- <script>  
    var socket = io.connect('http://localhost:8000');
      // socket.on('CSV_Name_error', function(data) { 
      //   if (data == "error"); 
      //   window.alert("잘못된 입력입니다.");  
      //  });  
  </script>    
  -->

  <style>
    #pyCodeEditor {
      position: absolute;
      width: 100%;
    }
    #asyncCodeEditor {
      position: relative;
      width: hidden;
    }
  </style>
</head>

<body>
  <!-- 언어 패키지, 카테고리 색상 -->
  <!-- 2020-12-05 양승국 동적 변경을 위해 head -> body로 옮김-->
  <script id = "lan" src="/js/blockly/msg/js/ko.js"></script> 

  <!-- 그래프 사이드바 start-->
  <aside id="sidebar">
    <!-- 그래프 사이드바 닫기 버튼 -->
    <div class="sidebar">
      <button id="runButton2" class="btn btn-outline-success btn-sm mr-1" onclick="runButton();"
        style="display:none;">실행</button>
      <!-- 실행 로딩 중 -->
      <div id="loading_image2" style="display: inline-block;">
        <object type="image/svg+xml" data="Rolling-1s-30px.svg"></object>
      </div>
      <button id = "button_close" class="btn btn-outline-primary btn-sm mr-1" onclick="sidebar_toggle();">닫기</button>
      <button id = "button_clear" class="btn btn-outline-danger btn-sm" onclick="csv_clear();">지우기</button>
      <button id = "button_reset" class="btn btn-outline-danger btn-sm" onclick="sidebar_clear();">전체 초기화</button>
    </div>

    <div id=graph></div>

    <div id=graph1 style="height:500px; width:900px;"><img id="pyplotfigure"/></div>
    <!-- <div id=graph2 style="height: 300px;"></div> 
      <div id=graph3 style="height: 300px;"></div>-->
    <div id="csv_show"></div>
  </aside>
  <!-- 그래프 사이드바 end-->

  <div class="container-fluid">
    <!-- nav -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #f4f6ff;">

      <!-- a -->
      <a class="navbar-brand" href="#"><img src="logo2-2.png"/></a>

      <!-- 왼쪽 구역-->
      <div class="d-flex flex-wrap text-white" style="width:80%;">

        <!-- 파일 열기 -->
        <div class="input-group col-md-3 ml-3 mt-2 btn-sm custom-file">
          <input type="file" id="file" class="custom-file-input" accept="text/xml"
            onchange="loadBlock(); this.value=null;return false;">
          <label class="custom-file-label mr-1" for="file">파일열기</label>
        </div>

        <!-- 블록 지우기 -->
        <input id="button_block_del" type="button" class="btn btn-outline-secondary btn-sm mr-0" onClick="demoWorkspace.clear();"
          value="블록 지우기" />

        <!-- 블록 저장 -->
        <input id="button_block_save" type="button" class="btn btn-outline-secondary btn-sm " value="블록 저장" onclick="saveBlock()"/>

        <!-- 블록 탭 -->
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-secondary mr-0" onclick="visibleBlock()">블럭</button>
          <button type="button" class="btn btn-secondary mr-0" onclick="visibleAll()">블럭+코드</button>
          <button type="button" class="btn btn-secondary mr-0" onclick="visibleCode()">코드</button>
        </div>
      </div>

      <!-- 오른쪽 구역 -->
      <div class="d-flex flex-wrap text-white" style="width: 60%;">

        <!-- 2020-12-05 양승국 언어변경을 위해 생성-->
        <!--언어변환 -->
        <!--
          21.03.26 지원 주석처리
          <select id="language" class="form-control col-md-2 mt-2 ml-1">
            <option id = "ko" value="kor">Ko</option>
            <option id = "en" value="eng">en</option>
          </select>
        -->
        <!-- 폰트크기변환 -->
        <select id="fontsize" class="form-control col-md-2 mt-2 ml-1">
          <option id = "none" value="none" selected>Font Size</option>
          <option id = "15" value="15">15</option>
          <option id = "20" value="20">20</option>
          <option id = "25" value="25">25</option>
          <option id = "30" value="30">30</option>
        </select>

        <!-- 실행 버튼 -->
        <input id="runButton1" type="button" class="btn btn-outline-success btn-sm mr-1" style="display:none;"
          onClick="runButton()" value="실행" /> <!-- 다시 원상 복귀 style="display:none;" [on click 전] -->
        <!-- 실행 로딩 중 -->
        <div id="loading_image1"><object type="image/svg+xml" data="Rolling-1s-30px.svg"></object></div>
        <!-- 결과 버튼 -->
        <input id="button_console_clear" type="button" class="btn btn-outline-secondary btn-sm mr-1" onClick=clear_result();
          value="결과 지우기" />

        <!-- 저장 버튼 -->
        <input id="button_code_save" type="button" class="btn btn-outline-secondary btn-sm mr-1" onClick=file_save();
          value="코드저장" />

        <!-- 파일 올리기 (지원)-->
        <input id="button_file_upload" type="button" class="btn btn-outline-secondary btn-sm " value="파일 업로드" onclick="localFileOpen3()"/>

        <!-- Button trigger modal 
        <button id = "button_paint" type="button" class="btn btn-outline-secondary btn-sm mr-1" data-toggle="modal"
          data-target="#staticBackdrop">그림판</button>-->

        <!-- Modal -->
        <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1"
          aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">그림판</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>

              <div class="modal-body">
                <!-- canvas -->
                <canvas id="canvas" class="canvas" width="300" height="300"></canvas>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary mr-1" data-dismiss="modal">취소</button>
                <!-- reset button -->
                <form>
                  <input type="button" id="reset" class="btn btn-danger mr-1" value="다시 그리기">
                </form>
                <a id="download" download="image.png"><button type="button" class="btn btn-primary"
                    onClick="canvas_save()">그림 저장</button></a>
                <input type="file" id="btn_upload" name="btn_upload" style="display: none;" />
              </div>
            </div>
          </div>
        </div> <!-- 모달 -->

        <!-- 그래프 버튼 -->
        <input id="sidebar_button" type="button" class="btn btn-outline-primary btn-sm" value="그래프"
          onclick="sidebar_toggle()" />

          

      </div> <!-- 오른쪽 구역 -->
    </nav>

    <!-- 하단 내용 -->
    <div class="row" style="height: 90vh;">

      <!-- 블럭 나오는 부분(왼쪽) -->
      <div id="blocklyDiv" class="col-md-8" style="height: 90vh;"></div>

      <!-- 오른쪽 -->
      <div id="codeDiv" class="col-md-4">
        <div id="codeDiv1">
          <div class="card shadow-sm">
            <div class="text-white bg-dark">
              <h6 id="code" class="my-1 mx-1">코드
                <input type="checkbox" checked id="toggle-two"/>
            </h6>
             <script>
              var global_var = true;
              $(function() {
                $('#toggle-two').bootstrapToggle({
                  off: '블록코드OFF',
                  on: '블록코드ON',
                  size: 'small',
                  onstyle:'primary',
                  offstyle:'default',
                  height: 5,
                  width: 135
                });
              })
              $(document).ready(function(){
                $("#toggle-two").change(function(){
                  separate_editor();
                  global_var = false;
                });
                
            });
              console.log('toggle: ' + $('#toggle-two').prop('checked'));
            </script>
            </div>
            <div style="position:relative; " style="height: 80vh;">
              <div id="pyCodeEditor"></div>
              <div id="jsCodeEditor" style="display: none"></div>
              <div id="asyncCodeEditor"></div>
            </div>
          </div>
        </div>
        <!-- console -->
        <div id="codeDiv2">
          <div class="card mb-6 mt-6 shadow-sm">
            <div class="text-white bg-dark">
              <h5 id="console" class="my-1 mx-1">콘솔</h5>
            </div>
            </textarea>
            <textarea id="exeArea" class="form-control" readonly style="height: 20vh;"></textarea>
          </div>
        </div>
      </div> <!-- 오른쪽 -->
    </div> <!-- 하단 -->

    <!-- camera-->
    <!--
    <video id="gum-local" autoplay playsinline></video>
    <button id="showVideo">Open camera</button>
    -->
  </div> <!-- container -->

  <!-- Toolbox 정의 -->


  <!-- code mirror -->
  <script>
    // JS 코드미러
    let jsEditor = CodeMirror(document.getElementById("jsCodeEditor"), {
      mode: "javascript",
      // value: "codemirror",
      theme: "oceanic-next",          // 테마
      inputStyle: "contenteditable",  // 입력 처리 방식
      // readOnly: true,              // 읽기 전용 설정
      lineNumbers: true,              // 라인 넘버 설정
      lineWrapping: true,             // 자동 줄바꿈 설정
      // spellcheck: true,   autocorrect: true,
    });

    // PY 코드미러
    let pyEditor = CodeMirror(document.getElementById("pyCodeEditor"), {
      mode: "python",
      // value: "codemirror",
      theme: "oceanic-next",          // 테마
      inputStyle: "contenteditable",  // 입력 처리 방식
      // readOnly: true,              // 읽기 전용
      lineNumbers: true,              // 라인 넘버 설정
      lineWrapping: true,             // 자동 줄바꿈 설정
      // spellcheck: true,            // 스펠링 체크
      extraKeys: { "Ctrl-Space": "autocomplete" }, // 단축키
      //   spellcheck: true,   autocorrect: true,
    });

     // async 코드미러
     let asyncEditor = CodeMirror(document.getElementById("asyncCodeEditor"), {
      mode: "python",
      // value: "codemirror",
      theme: "oceanic-next",          // 테마
      inputStyle: "contenteditable",  // 입력 처리 방식
      // readOnly: true,              // 읽기 전용 설정
      lineNumbers: true,              // 라인 넘버 설정
      lineWrapping: true,             // 자동 줄바꿈 설정
      // spellcheck: true,   autocorrect: true,
    });

    // (demoWorkspace = 블록배치하는 공간) 블록이 나타나는 부분
    var demoWorkspace = Blockly.inject( 
      "blocklyDiv", {
        toolbox: toolbox, // 툴박스  보이기 
        grid: // 그리드 보이기 
        {
          spacing: 0,
          length: 3,
          colour: '#ccc',
          snap: true
        },
        zoom: // 줌 기능 3단계 변경
        {
          controls: true,
          wheel: true,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2,
          //pinch: true
        },
        trashcan: true, // 휴지통
        /*theme: {
          'blockStyles': {
            "list_blocks": {
              "colourPrimary": "#4a148c",
              "colourSecondary": "#AD7BE9",
              "colourTertiary": "#CDB6E9"
            }
          },
          'categoryStyles': {
            "list_category": {
              "colour": "#4a148c"
            }
          },
          'componentStyles': {
            'toolboxBackgroundColour': '#848484', // toolbox background
            'toolboxForegroundColour': '#fff',
            'flyoutBackgroundColour': '#D8D8D8', // toolbox color
          }
        }*/
        renderer: "zelos" // 제로스 테마
      }
    );

    // 생성될 코드에 대해 선택하는 부분 -> 사용할때마다 선언해서 굳이 필요 없어보임.
    //var jsCode = Blockly.JavaScript.workspaceToCode(demoWorkspace); // 자바 스크립트 선택 
    //var pyCode = Blockly.Python.workspaceToCode(demoWorkspace); // 파이썬 선택 

    
    //==================================
    // 블록 저장하기 
    //===================================  
    function saveBlock() {
      let xml = Blockly.Xml.workspaceToDom(demoWorkspace);  // 워크스페이스를 돔(xml)로 만듬
      let p_xml = Blockly.Xml.domToPrettyText(xml);         // 돔(xml)을 깔끔하게 만드는 부분

      prompt2("블록 저장하기", checkCookie("download_block"), "저장", "취소").then((filename) => {
        if(filename != null){
          setCookie("download_block",filename,"1"); // 사용자가 정한 파일명을 다시 쿠키에 저장
          let fileObject = new File([p_xml], filename+".xml");  // 파일 객체 생성 (data,name+확장자)
          saveAs(fileObject);                                   // 로컬 저장
        }
      });
    }

  
    //===================================
    // 블록 불러오기 
    //===================================   
    function loadBlock() {
      let reader = new FileReader();  // FileReader객체 생성
      let files = document.getElementById("file").files; // 로컬에 있는 파일의 id값 얻기
      let file = files[0];
      let fileName = "";  
      if (file) {
        reader.onload = function (e) {          // 파일읽기 성공한 경우
          var xml = reader.result;              // 읽어들인 파일 내용
          var dom = Blockly.Xml.textToDom(xml); // text를 돔 형태로 변환
          Blockly.Xml.appendDomToWorkspace(dom, demoWorkspace); //  돔을 디코딩 후 워크스페이스에 블록을 만들어 냄.
          fileName = file.name;
          
          // 워크스페이스에 있는 블록을 코드로 변환해 코드미러에 setValue해주는 부분
          try {
            var pyCode = Blockly.Python.workspaceToCode(demoWorkspace);
            pyEditor.setValue(pyCode);
          } catch (e) {
            console.log('python 코드가 매핑되어 있지 않습니다. Error : ' + e);
          }
          try {
            var jsCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);
            jsEditor.getValue() = jsCode;
          } catch (e) {
            console.log('java script 코드가 매핑되어 있지 않습니다. Error : ' + e);
          }
        };
        reader.readAsText(file);
      }
    }

    function separate_editor(){

      var pyEditor = $("#pyCodeEditor");
      var asyncEditor = $("#asyncCodeEditor");



      if ($('#toggle-two').prop('checked') === false) {
        
        //pyEditor.css("position", "relative");
        //pyEditor.slideUp("400");
        //asyncEditor.slideDown("400");
        asyncEditor.css("visibility", "visible");
        pyEditor.css("visibility", "hidden");
      } else if ($('#toggle-two').prop('checked') === true) {

        //pyEditor.css("position", "relative");
        //pyEditor.slideDown("400");
        //asyncEditor.slideUp("400");
        pyEditor.css("visibility", "visible");
        asyncEditor.css("visibility", "hidden");
      }

    }

    // ==================================
    // 코드 갱신하기 
    //===================================  
    function codeUpdate(event) {
      async function coderun() {
        try {
          var pyCode = Blockly.Python.workspaceToCode(demoWorkspace); // 워크스페이스를 코드로 변환 후 값 저장
          // console.log("pycode : " + escape(pyCode));
          pyEditor.setValue(pyCode); // 그 값을 파이썬코드미러에 값 저장
        } catch (e) {
          console.log('python 코드가 매핑되어 있지 않습니다. Error : ' + e);
        }
      }
      // coderun이 끝나고나서 작동됨.
      coderun().then(() => {
        try {
          var jsCode = Blockly.JavaScript.workspaceToCode(demoWorkspace); // 워크스페이스를 js코드로 변환 후 값 저장
          jsEditor.setValue(jsCode); // 그 값을 js코드미러에 값 저장
        } catch (e) {
          console.log('java script 코드가 매핑되어 있지 않습니다. Error : ' + e);
        }
      });
    }

    //==================================
    // 결과 지우기 2020.10.04 남지원 수정 
    //===================================  
    function clear_result() {
      //원본 document.getElementById("exeArea").value = "";
      $("#exeArea").empty();
    }

    // ==================================
    // 코드 파일로 저장하기
    //===================================  
    function file_save_2(editor){
      var code_python = Blockly.Python.workspaceToCode(demoWorkspace); // 워크스페이스를 파이썬 코드로 변환
      var code = editor.getValue();
      var blobObject = new Blob([code]);  // 코드를 블롭 객체로 만듬 => 블롭은 이미지, 사운드, 비디오와 같은 멀티미디어 데이터를 다룰 때 사용
      // 이름을 받아서 saveAs
      //let filename = prompt("다른이름으로 저장."); 

      prompt2("코드 저장하기", checkCookie("download_block"), "저장", "취소").then((filename) => {      
        if(filename != null){
          setCookie("download_block",filename, 1); // 사용자가 정한 파일명을 다시 쿠키에 저장
          saveAs(blobObject, filename+".py"); 
        }
      });
    }

    function file_save() {   
      console.log('test toggle-two: ' + $('#toggle-two').prop('checked'));

      if($('#toggle-two').prop('checked'))
        file_save_2(pyEditor);
      else
        file_save_2(asyncEditor);
      

      
    }

    // ==================================
    // 블록을 선택했을 때 
    //=================================== 
    function whenSelected(event) {
      if (event.type == Blockly.Events.CREATE) {
        let block = demoWorkspace.getBlockById(event.blockId); 
        console.log('블록이 선택됨');
      }

      // 블록을 눌렀을 때 클릭 이벤트로 각종 메소드 작동
      if (event.type == Blockly.Events.UI && event.element === "click") {
        let block = demoWorkspace.getBlockById(event.blockId);
        // 판다스에서 쓰이는 csv불러와서 데이터 프레임 만들어주는거
        if ('csv2' == block.type) {
          openTextFile(event.blockId);
        }

        // 기태 수정(로컬 파일 열기) 21.01.01 ==============================================
        //판다스의 파일열기
        if ('fileopen' == block.type) {
          console.log("파일 열기");
          localFileOpen(event.blockId);         
        }
        //사이파이의 미디어불러오기
        if ('fileopen2' == block.type) {
          console.log("미디어 파일 열기");
          localFileOpen2(event.blockId);         
        }
        // 기태 수정(로컬 파일 열기) 지금은 사용되지 않음 ========================================================
        if ('data_csv_read' == block.type) {
          Show_csv();
        }
        // 다운로드 블록 창 열기
        if ('os_data_download'  == block.type) {
          fileDownload();
        }

        // croll_url_load
        if('croll_url_load' == block.type){
          _requestsURL(event.blockId);
        }
      }
    }
    demoWorkspace.addChangeListener(codeUpdate);  // 코드 갱신하기 메소드
    demoWorkspace.addChangeListener(whenSelected);// 선택 되었을 때 메소드
  </script>

  <script>
    function runcode_2(code, code2){
      console.log(code); // 파이썬코드찍는부분
      console.log("-----");
      console.log(code2); // 자바스크립트코드 찍는부분
      var exe = document.getElementById('exeArea'); // 콘솔 창 ID가져옴
      languagePluginLoader.then(() => {
        try {
          exe.innerHTML = pyodide.runPython(code);
          let stdout = pyodide.runPython("sys.stdout.getvalue()"); // 결과값을 싹 받아줌
          exe.innerHTML = stdout;
        } catch (e) {
          exe.innerHTML = e;  
        }
      });
    }
  </script>

  <script>
  //==================================
  // 블록을 실행했을 때 
  //==================================
    //새로운 실행방법
    function runButton() {
      
      // 그래프 위쪽 삭제
      $("#graph1").remove();
      $("#csv_show").before("<div id='graph1' style=\"height:500px; width:900;\"><img id='pyplotfigure' /></div>");
      // 그래프 위쪽 삭제

      // 그래프같은 이미지들을 싹다 잡아옴 plt.show()하면 바로 되는이유
      globalThis.iodide = {
        output: {
          element: (tagName) => {
            let outputPane = document.createElement(tagName);
            document.querySelector("#graph1").appendChild(outputPane);
            console.log(outputPane)
            return outputPane;
          }
        }
      };

      Blockly.Python.addReservedWords('code');      // // 이 언어의 예약어 목록에 하나 이상의 단어를 추가한다.
      var code = pyEditor.getValue();               // py 코드미러의 값을 code로 저장
      Blockly.JavaScript.addReservedWords('code2'); // // 이 언어의 예약어 목록에 하나 이상의 단어를 추가한다.
      var code2 = jsEditor.getValue();              // js 코드미러의 값을 code2로 저장
      
      Blockly.Python.addReservedWords('code_async');
      var code_async = asyncEditor.getValue();
      // 이 부분이 코드 싹다 잡아와서 출력
      // 실행했을때 그래프를 지우고 하기 위해
      // plt.cla - 클리어
      // plt.clf - figure클리어
      // os는 data폴더 mount 에러 임시로 해결하기 위해
      languagePluginLoader.then(() => {
        pyodide.runPython(`
                    import sys
                    import os 
                    import io
                    import matplotlib.pyplot as plt
                    plt.cla()
                    plt.clf()
                    sys.stdout = io.StringIO()
                    `);

        // chdir 에러 구현
        if(code){
          
          if (code.indexOf("os.chdir") != -1){
            
            var current_path = pyodide.runPython(`os.getcwd()`); // 현재 경로 받아옴
            var dir_list = pyodide.runPython(`os.listdir()`); // 디렉토리 비교하기 위해
            var root_list = pyodide.runPython(`os.listdir('/')`);

            var start_index = code.indexOf("os.chdir("); 
            var end_index = code.indexOf(")", start_index);

            var replace_str = code.substr(start_index, (end_index - (start_index - 1)))

            // 1. start_index부터 앞쪽으로 검색하여 개행이 어디 있는 지 확인하고, 몇번째 문자인지 변수에 저장
            var err_index = (start_index + 10) - (code.lastIndexOf("\n", start_index + 10) - 1);
            
            // 2. start_index부터 앞쪽으로 검색하여 개행이 몇개인지 파악하고, 몇번째 라인인지 확인
            var err_str = code.substr(0, start_index + 10);
            var err_line = err_str.match(/\n/g);
            if(err_line === null) 
              err_line = 1;
            else
              err_line = err_str.match(/\n/g).length + 1;
            
            var err_dir = code.substr(start_index + 10, ((end_index-2) - (start_index + 10 - 1)))

            var output_err = "Error: Traceback (most recent call last):"
            var output_err2 = "File \"/lib/python3.8/site-packages/pyodide/_base.py\", line 70, in eval_code"
            var output_err3 = "eval(compile(mod, \"<exec>\", mode=\"exec\"), ns, ns)"
            var output_err4 = "File \"<exec>\", line " + String(err_line) +", in <module>"
            var output_err5 = "FileNotFoundError: [Errno 2] No such file or directory: "

            if (current_path.indexOf("/data") != -1){ // data 하위 디렉토리 모두 적용
              
              let dir_index;
              let bool_;

              for(dir_index = 0; dir_index < dir_list.length; dir_index++){
                if(dir_list[dir_index] == err_dir || err_dir.indexOf('/') != -1 || err_dir.indexOf('../') != -1){
                  bool_ = false;
                  break;
                }else if(err_dir == '..' || err_dir == '.'){
                  bool_ = false;
                  break;
                }else
                  bool_ = true;
              }

              if (dir_list.length == 0 && !(err_dir.indexOf('/') != -1 || err_dir.indexOf('../') != -1 || err_dir == '..' || err_dir == '.'))
                bool_ = true; // 디렉토리 내부가 비어 있을 때도 적용
                

              if(bool_ == true){
                code = code.replace(code, '');
                //code = code.replace(replace_str, '"' + output_err + '"');
                code = "print('" + output_err + "')";
                code = code + ("\nprint(' " + output_err2 + "')");
                code = code + ("\nprint('  " + output_err3 + "')");
                code = code + ("\nprint(' " + output_err4 + "')");
                code = code + ('\nprint("' + output_err5 + "'" + err_dir + "'" + '")');
                console.log('data폴더');
              }
            }
          }
          // 크롤링 req.text부분 처리
          if (code.indexOf("req.text") != -1){
            code = code.replace("req.text", 'req');
          }
        }

      });



      // 순차적 실행을 위해 놓은 코드 async, .then()
      async function runcode() {

        "use strict";
        if($('#toggle-two').prop('checked'))
          runcode_2(code, code2);
        else
          runcode_2(code_async, code2);
          
        }
        // runcode끝내고 또 돌림, 테이블 형식 블록을위해 이걸 넣어줌
        runcode().then(() => {
          if(eval(code2)==undefined){
            document.getElementById('exeArea').innerHTML+='\n';
          } else{
            console.log("error : javascript code error");
          }
        })

     
    }
    // 기존 실행 버튼
    // function runButton() {
    //   Blockly.Python.addReservedWords('code');
    //   var code = pyEditor.getValue();

    //   Blockly.JavaScript.addReservedWords('code2');
    //   var code2 = jsEditor.getValue();

    //   async function runcode() {
    //     languagePluginLoader.then(() => {
    //       try { pyodide.runPython(code); }
    //       catch (e) { document.getElementById('exeArea').innerHTML = e; }
    //     });
    // 명성이형 그래프 추가(일단 주석처리)
    // languagePluginLoader.then(await function () {
    //   if (DL_Gra == "chcked") { document.getElementById("pyplotfigure").src = pyodide.globals.img_str;}
    // });
    // DL_Gra = 0;
    //   };
    //   runcode().then(() => {
    //     document.getElementById('exeArea').innerHTML = eval(code2);
    //   });
    // };
      
    //======================
    // .csv를 테이블로 만들기 
    //======================
    function openTextFile(blockId) {
      var input = document.createElement("input");
      input.type = "file";
      input.accept = ".csv"; // 확장자가 xxx, yyy 일때, ".xxx, .yyy"
      input.onchange = function (e) {
        $("#tblshow").empty();
        $("#tblhead").empty();
        ///////////////////////////////////////////
        var fileArray = new Array(); // csv to json?
        if (e.target.files != undefined) {
          var reader = new FileReader();
          reader.onload = function (e) {
            var csvval = e.target.result.split("\n"); // 개행으로 나누고
            var csvvalue = csvval[0].split(",");      // ,로 나누고 
            var inputrad = "";
            // csv view! header 1
            for (var i = 0; i < csvvalue.length; i++) {
              var header = csvvalue[i];
              addOptions(header);
            }
            csvval[0] = csvval[0].replace('\r', ''); // 커서가 맨 앞에 있으면 없애고
            // row
            var cnt = (csvval.length < 2000) ? csvval.length : 2000; // 갯수를 2000개까지
            for (var i = 1; i < cnt - 1; i++) {
              csvval[i] = csvval[i].replace('\r', '');
              var cols = csvval[i].split(',');
              var fileObject = new Object();
              for (var j = 0; j < cols.length; j++) {
                var value = cols[j];
                var name = csvval[0].split(',')[j] // hedaer name
                fileObject[name] = value; // value
                // table body add
              }
              fileArray.push(fileObject);
            }
            create_table($("#csv_show")[0], JSON.stringify(fileArray));
            // // 파일 set
            var block = demoWorkspace.getBlockById(blockId);
            var bId = Blockly.mainWorkspace.getBlockById(blockId)
            block.setFieldValue(JSON.stringify(fileArray), 'csv_url'); // csv_url -> field_input ID
          };
          reader.readAsText(e.target.files.item(0), /* optional */ "euc-kr");
        }
      };
      input.click();
    }

    // **************************************
    // ********   테이블 그리기      *********
    // ************************************** 
    function draw_table(Get_CSV_DATA, Get_CSV_Header) {

      var NPTD_Data = Array.from(Array(Get_CSV_DATA[0].length), () => new Array(Get_CSV_DATA.length));

      for (var i = 0; i < Get_CSV_DATA.length; i++) {
        for (var j = 0; j < Get_CSV_DATA[0].length; j++) {
          NPTD_Data[j][i] = Get_CSV_DATA[i][j];
          // console.log(NPTD_Data[j][0]);
        }
      }

    var NPTD_Data_Header = Array.from(Array(NPTD_Data.length), () => new Array(NPTD_Data[0].length));

  //--------------------------------- data 속성 ---------------------------// 
  var data = [{
    type: 'table',

    //--------------헤더 설정 ---------------// 
    header: {
      values: Get_CSV_Header,
      line: {
        width: 1,
        color: 'black'
      },
      fill: {
        color: "grey"
      },
      font: {
        family: "Arial",
        size: 12,
        color: "white"
      }
    },
    //--------------셀 설정 ---------------//
    cells: {
      values: NPTD_Data,
      align: "center",
      line: {
        color: "black",
        width: 1
      },
      font: {
        family: "Arial",
        size: 11,
        color: ["black"]
      }
    }
  }]
  var title = "테이블 확인 하기 "
  var graph = "graph1"
  var layout = {title: title}
  //--------------------------------- data 속성 ---------------------------//
  Plotly.newPlot(graph, data, layout);
}


function Check_matplotlib_user_input(a, b) {
    if (a == 1 && b == 1) {
        DL_Gra = "graph_both_1";
    } else if (a == 1 || b == 1) {
        DL_Gra = "graph_or_1";
    } else {
        DL_Gra = 0;
    }
}

// 화면에 찍기 프린트
function printc(x) {
  var savetext = $('#exeArea').val();
  $('#exeArea').val(savetext + x + '\n');
}

</script>

  <!-- <script src="/js/utils/canvas.js"></script> 그림판 -->

  <!-- 2020-12-05 양승국 언어변경 -->
  <script>
    $("#language").change(function () {
      var selectName = $(this).find(":selected").val();

      if (selectName == "kor") {
        $("#lan").remove();
        var script = document.createElement('script');
        script.id = 'lan';
        script.src = '/js/blockly/msg/js/ko.js'; // script url.
        document.body.appendChild(script);
      }
      else if (selectName == "eng") {
        $("#lan").remove();
        var script = document.createElement('script');
        script.id = 'lan';
        script.src = '/js/blockly/msg/js/en.js'; // script url.
        document.body.appendChild(script);
      }  
    });
    
  </script>
 <!-- 전우진 폰트 크기 변경 -->
<script>
  $("#fontsize").change(function () {
    var selectName = $(this).find(":selected").val();

    if (selectName == "none") {
    }
    if (selectName == "15") {
      $('.CodeMirror').css('fontSize', '15px');
    }
    else if (selectName == "20") {
      $('.CodeMirror').css('fontSize', '20px');
    }
    else if (selectName == "25") {
      $('.CodeMirror').css('fontSize', '25px');
    }
    else if (selectName == "30") {
      $('.CodeMirror').css('fontSize', '30px');
    } 
  });
</script>

  <!-- 데이터 입력 bug fix -->
  <script>
    function input_fixed(text) {
        return prompt(text);
    };
    
    languagePluginLoader.then(() => {
      pyodide.runPythonAsync(`
        from js import input_fixed
        input = input_fixed
        __builtins__.input = input_fixed

        
        `);
    });
  </script>

    <!-- 로컬 파일 오픈하기 -->
    <script>
    var datas="";           // 데이터 변수 초기화
    var fss;                // FS가 BrowserFS와 겹치기 때문에 재 생성
    var fileName2="temp";   // 파일 명   
    var rows = "";          // ?
    
    //== 기태 수정 (로컬 파일 열기 ) 21.01.01 =============================================
    // 텍스트 파일 처리하기 
    function localFileOpen(blockId) {
      console.log("local Text FileOpen");
      var input = document.createElement("input"); // input 태그를 하나 만든다.
      // 태그 속성 정의
      input.type = "file";
      input.accept = ".txt, .csv"; // 확장자가 xxx, yyy 일때, ".xxx, .yyy"
      input.onchange = function (e) { // input의 값이 변하면 => 파일을 불러오면
        if (e.target.files != undefined) { // 이중부정을 굳이?
          console.log("txt or csv 파일 불러옴")
          var reader = new FileReader(); // 파일리더 객체 생성
        
          // reader가 준비되면 
          reader.onload = function (e) { 
            datas = e.target.result;      // 다읽어온 파일의 값을 datas에 저장      
            console.log("datas", datas);  // datas 출력 => txt나 csv를 출력한번 해본다.
            fss.writeFileSync(fileName2, datas); // FS에 파일명으로 datas를 저장
            var block = demoWorkspace.getBlockById(blockId); // 블럭안의 input에 파일 경로를 적기위해 블럭 찾음
            var bId = Blockly.mainWorkspace.getBlockById(blockId) // ???
            block.setFieldValue(JSON.stringify("data/" + fileName2), 'file_path'); // 블럭안에 input에 파일경로를 적어줌
          };

          fileName2 =  e.target.files[0].name;  // 파일명 받아옴
          console.log(fileName2);               // 파일명 출력해봄
          reader.readAsText(e.target.files[0]); // 리더객체가 텍스트를 읽음        
        }
      };
      input.click(); // 블럭이 클릭되면 실행
    }

    function localFileOpen3() {
      console.log("local Text FileOpen3");
      let input = document.createElement("input"); // input 태그를 하나 만든다.
      // 태그 속성 정의
      input.type = "file";
      input.onchange = function (e) { // input의 값이 변하면 => 파일을 불러오면
        fileName2 =  e.target.files[0].name;
        console.log(fileName2);
        // 파일명, 확장자 분리작업
        let _fileLen = fileName2.length;                                      // 파일명의 길이
        let _lastDot = fileName2.lastIndexOf('.');                            // 파일명에서 가장 마지막에 나오는 .확인 => 확장자 체크
        let _fileExt = fileName2.substring(_lastDot, _fileLen).toLowerCase(); // 확장자를 소문자로 변경해 저장

        // 확장자가 wav일때 + 폰트 처리를 위해 확장자 추가 (2021.03.03 - 기태)
        if(_fileExt == ".wav" || _fileExt == ".ttf" ){
          if (e.target.files != undefined) {
            console.log("웨이브 파일")
            var reader = new FileReader();
          
            reader.onload = function (e) {
              datas = e.target.result;          
              console.log("datas", datas);    
              // wav 파일 처리하기 
              fss.writeFileSync(fileName2, Buffer(new Uint8Array(datas))); // 버퍼 배열로 파일 저장
            };
            fileName2 =  e.target.files[0].name;
            console.log(fileName2);
            reader.readAsArrayBuffer(e.target.files[0]);  // 웨이브 파일은 버퍼로 읽어온다    
          }
        } else if(_fileExt == ".jpg" || _fileExt == ".png" || _fileExt == ".bmp" ) { // 확장자가 wav가아니면 이미지라고 판단
          if (e.target.files != undefined) {
            console.log("이미지 파일")
            var reader = new FileReader();
            
            // reader가 이미지를 다 읽었을때 실행
            reader.onload = function (e) {
              datas = e.target.result;  // 이미지 값을 datas에 저장
              console.log("datas", datas);    
              var data = datas.replace(/^data:image\/\w+;base64,/, ""); // 이 부분을 삭제함
              var buf = Buffer.from(data, 'base64');  // base64 버퍼로 저장
              fss.writeFileSync(fileName2, buf); 
            };
            reader.readAsDataURL(e.target.files[0]);  // reader가 이미지를 읽음   
          }
        } else {
          if (e.target.files != undefined) { // 이중부정을 굳이?
            var reader = new FileReader(); // 파일리더 객체 생성
          
            // reader가 준비되면 
            reader.onload = function (e) { 
              datas = e.target.result;      // 다읽어온 파일의 값을 datas에 저장      
              console.log("datas : ", datas);  // datas 출력 => txt나 csv를 출력한번 해본다.
              fss.writeFileSync(fileName2, datas); // FS에 파일명으로 datas를 저장
            };

            fileName2 =  e.target.files[0].name;  // 파일명 받아옴
            console.log(fileName2);               // 파일명 출력해봄
            reader.readAsText(e.target.files[0]); // 리더객체가 텍스트를 읽음        
          }
        };
      }
      input.click(); // input을 클릭했을 때. 
    }

    // 미디어 파일 처리하기 
    function localFileOpen2(blockId) {
      console.log("local Image FileOpen");
      var input = document.createElement("input");
      input.type = "file";
      input.accept = ".jpg, .png, .bmp, .wav, .ttf"; // 확장자가 xxx, yyy 일때, ".xxx, .yyy"
      input.onchange = function (e) {
      
      fileName2 =  e.target.files[0].name;
      console.log(fileName2);

      // 파일명, 확장자 분리작업
      var _fileLen = fileName2.length;                                      // 파일명의 길이
      var _lastDot = fileName2.lastIndexOf('.');                            // 파일명에서 가장 마지막에 나오는 .확인 => 확장자 체크
      var _fileExt = fileName2.substring(_lastDot, _fileLen).toLowerCase(); // 확장자를 소문자로 변경해 저장

      // 확장자가 wav일때 + 폰트 처리를 위해 확장자 추가 (2021.03.03 - 기태)
      if(_fileExt == ".wav" || _fileExt == ".ttf" ){
        if (e.target.files != undefined) {
          console.log("웨이브 파일")
          var reader = new FileReader();
        
          reader.onload = function (e) {
            datas = e.target.result;          
            console.log("datas", datas);    
            // wav 파일 처리하기 
            fss.writeFileSync(fileName2, Buffer(new Uint8Array(datas))); // 버퍼 배열로 파일 저장
            var block = demoWorkspace.getBlockById(blockId);
            var bId = Blockly.mainWorkspace.getBlockById(blockId)
            block.setFieldValue(JSON.stringify("data/" + fileName2), 'file_path');
          };
          fileName2 =  e.target.files[0].name;
          console.log(fileName2);
          reader.readAsArrayBuffer(e.target.files[0]);  // 웨이브 파일은 버퍼로 읽어온다    
        }
      } else { // 확장자가 wav가아니면 이미지라고 판단
        if (e.target.files != undefined) {
          console.log("이미지 파일")
          var reader = new FileReader();
          
          // reader가 이미지를 다 읽었을때 실행
          reader.onload = function (e) {
            datas = e.target.result;  // 이미지 값을 datas에 저장
            console.log("datas", datas);    
            var data = datas.replace(/^data:image\/\w+;base64,/, ""); // 이 부분을 삭제함
            var buf = Buffer.from(data, 'base64');  // base64 버퍼로 저장
            fss.writeFileSync(fileName2, buf); 
            var block = demoWorkspace.getBlockById(blockId);
            var bId = Blockly.mainWorkspace.getBlockById(blockId)
            block.setFieldValue(JSON.stringify("data/" + fileName2), 'file_path');
          };
          reader.readAsDataURL(e.target.files[0]);  // reader가 이미지를 읽음   
        }
      }
    };
    input.click(); // input을 클릭했을 때. 
    }
    //=====기태 처리 (파일) 21.01.06  : 파일 로딩에 대해 인터벌 적용 ================================
    setTimeout(function() {
      BrowserFS.install(window);
      BrowserFS.configure({
            //fs: "LocalStorage"
            fs: "InMemory"      // 5MB 이상의 큰 파일 처리를 위해 변경(2021.03.03 - 기태)
        }, function(e) {
            fss = require('fs'); // [Node.JS] fs의 기능을 fss로 이동 => 브라우저 fs와 겹침방지
            
            var fs = BrowserFS.BFSRequire('fs'); // [BrowserFS] 사용하려면 기본적으로 필요한 건가봄?
            fss.writeFileSync(fileName2, ""); // temp라는 이름의 빈 파일 생성

            // [Pyodide] languagePluginLoader : pyodide초기화? 시작할때 무조건 필요 
            languagePluginLoader.then(async ()=>{   
    
              // pyodide모듈 로드     
              pyodide.loadPackage(['pandas', 'numpy', 'matplotlib','biopython','beautifulsoup4','scipy','sympy', 'scikit-learn', 'scikit-image']).then(() => {
                console.log("모듈 로드 완료.");
              })
              
              let FS = pyodide._module.FS; // 모듈의 파일시스템
              let PATH = pyodide._module.PATH; // 모듈의 경로
              
              console.log(FS.mount);
              console.log(PATH);

              // Create an Emscripten interface for the BrowserFS
              var BFS = new BrowserFS.EmscriptenFS(FS, PATH);
              // Create mount point in Emscripten FS
              FS.createFolder(FS.root, 'data', true, true);
              // Mount BrowserFS into Emscripten FS
              FS.mount(BFS, {root: '/'}, '/data');

              
              // 이부분은 내부 콘솔(f12 X)에 찍어주기 위해 필요한 부분
              // requests class 임의로 만들어줌. 
              pythonCode = `              
                import sys
                from io import StringIO
                # 크롤링 하기위해 js로만든 _requestsURL 메소드 import
                from js import _requestsURL

                req = ""

                class requests:
                  def get(htmlurl):
                    _requestsURL(htmlurl)
                    return req

                sys.stdout = StringIO()      
              `
              // 비동기 부분 다 끝나고 이거 되는거같음
              languagePluginLoader.then(() => {
                return pyodide.loadPackage(['micropip'])
              }).then(() => {
                pyodide.runPython(pythonCode);
                console.log('pyodide 라이브러리 로딩완료');
                $("#loading_image1").hide(); // 홈페이지 로딩 끝나면 로딩 이미지 없앰 
                $("#runButton1").css({
                    'display': "block"
                });
                $("#loading_image2").hide(); // 그래프 로딩 끝나면 로딩 창 없앰 
                $("#runButton2").css({
                    'display': "inline"
                });       
              }) 
                
            });
        });
    }, 1000);  // js 파일 다운로드를 위해 인터벌 설정 
    </script>   
    <script>
      // 파일 다운로드 
      function fileDownload(){
        var minetype;     // 데이터 타입 
        var blob;         // 블롭 변수
        var base64Image;  // base64이미지

        var _filename = prompt("저장할 파일명을 입력해주세요(ex> hello.txt)");    // 파일명+확장자 입력
        if(_filename != null){
          var _fileLen = _filename.length;                                      // 파일명의 길이
          var _lastDot = _filename.lastIndexOf('.');                            // 파일명에서 마지막에 나오는 '.'찾기 -> 확장자를 찾을수있음
          var _fileExt = _filename.substring(_lastDot, _fileLen).toLowerCase(); // 분리된 파일 확장자
        }

        // readFile - 인코딩 없이 minetype으로 구분해서 처리하면 됨.
        fss.readFile(_filename, function(err, data) {
          console.log(data); // data정보 확인
          // 에러가 났을 때
          if(err){
            alert("해당 파일이 존재하지 않습니다.");
            return;
          }

          // 확장자 비교 후 작동.
          if(_fileExt == '.txt'){
            minetype = "text/plain;charset=utf-8";            
          } else if(_fileExt == '.csv'){
            minetype = "text/csv;charset=utf-8";
          } else if(_fileExt == '.bmp'){            
            minetype : 'image/bmp';            
          } else if(_fileExt == '.jpg'){  
            minetype = 'image/jpeg';             
          } else if(_fileExt == '.wav'){            
            minetype : 'audio/wav';           
          }
          
          // 블롭 생성
          blob = new Blob([data], { type: minetype });
          console.log(blob);
          // 블롭 저장.
          saveAs(blob, _filename);
          
        });
      }
    </script> 
    <!-- 기태 처리 (파일) 끝 20.12.29 ------------------------------------------------------------------------->
</body> 
<!--camera
<script src="/js/blockly/cam.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
-->
</html>