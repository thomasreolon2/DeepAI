<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BlockJas</title>
  <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
  <script src="/js/blockly/storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
  <script src="/js/blockly/brython.js"></script>
  <script src="/js/blockly/brython_stdlib.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"> </script>
  <!--  Blockly 자체의 설정과 관련된 파일 -->
  <!--   javascript 언어 규칙 및 블록 변환과 관련된 내용을 압축한 파일 -->
  <script src="/js/blockly/blockly_compressed.js"></script>
  <script src="/js/blockly/javascript_compressed.js"></script>
  <script src="/js/blockly/python_compressed.js"></script>
  <script src="/js/blockly/blocks_compressed.js"></script>
  <!--미리 정의되어 있는 기본 블록에 대한 설정을 모두 담고 있음.-->

  <script src="/js/blockly/test.js"></script> <!-- Prolog 블록 -->
  <script src="/js/blockly/test_gen.js"></script>

  <script src="/js/blockly/msg/js/ko.js"></script> <!-- 언어 패키지 -->
  <script src="/js/blockly/FileSaver.js"></script> <!-- 파일 저장 기능 -->
  <script src="/js/blockly/tau-prolog.js"></script> <!-- tau Prolog 추가 -->
  <!--plotly cdn-->
  <script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>
  <!--numjs-->
  <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
  <!--Mathjs-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/7.2.0/math.min.js"></script>
  <!-- codemirror 추가 -->
  <script src="/js/codemirror/lib/codemirror.js"></script>
  <link rel="stylesheet" href="/js/codemirror/lib/codemirror.css">
  <script src="/js/codemirror/mode/javascript/javascript.js"></script>
  <script src="/js/codemirror/mode/python/python.js"></script>
  <!-- codemirror 추가 -->

  <!-- codemirror 스타일 지정 -->
  <link rel="stylesheet" href="./js/codemirror/theme/oceanic-next.css">
  <!-- codemirror 스타일 지정 -->

  <!-- cdoemirror 자동 완성 기능 -->
  <script src="./js/codemirror/addon/hint/show-hint.js"></script>
  <script src="./js/codemirror/addon/hint/javascript-hint.js"></script>
  <script src="./js/codemirror/addon/hint/anyword-hint.js"></script>
  <link rel="stylesheet" href="./js/codemirror/addon/hint/show-hint.css">
  <!-- cdoemirror 자동 완성 기능 -->

  <!--jquery-->

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


  <!-- bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>

  <!--css-->
  <link rel="stylesheet" href="css\sidebar.css">

  <!-- table -->
  <link rel="stylesheet" href="/css/table_custom.css">
  <style type="text/css">
    canvas {
      background-color: white;
      border: 1px solid black
    }

    .btn {
      margin: 10px;
    }

    .file {
      margin: 10px;
    }

    .form-control {
      height: 50%;
    }

    div {
      overflow: hidden;
      height: auto;
    }

    .canvas {
      margin-left: 10px;
    }

    #jsCodeEditor {
      position: absolute;
      width: 100%;
    }

    #pyCodeEditor {
      position: relative;
      visibility: hidden;
    }
  </style>
</head>

<body onload="">
  <!--사이드바-->
  <div>
    <aside id="sidebar">
      <button><span class="btn_t" style="color:black">그래프</span></button>
      <div id=graph></div>
      <!-- <div id=graph1 style="height: 300px;"></div>
      <div id=graph2 style="height: 300px;"></div>
      <div id=graph3 style="height: 300px;"></div> -->
      <div class="table_scroll">
        <table class="table table-sm">
          <thead id="tblhead"></thead>
          <tbody id="tblshow"></tbody>
        </table>
      </div>
    </aside>
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="d-flex flex-wrap text-white" style="width: 50%;">
        <div class="input-group col-md-4 ml-3 mt-2 btn-sm custom-file">
          <input type="file" id="file" class="custom-file-input" accept="text/xml"
            onchange="loadBlock();this.value=null;return false;">
          <label class="custom-file-label" for="file">파일열기</label>
        </div>
        <input id="button" type="button" class="btn btn-outline-secondary btn-sm" onClick="demoWorkspace.clear();"
          value="블록 지우기" />
        <input id="button" type="button" class="btn btn-outline-secondary btn-sm" onClick="saveBlock();"
          value="블록 저장" />
      </div>
      <div class="d-flex flex-wrap text-white" style="width: 50%;">
        <select id="display_select" class="form-control col-md-3 mt-2 ml-3">
          <option value="javascript">javascript</option>
          <option value="python">python</option>
        </select>
        <input id="button" type="button" class="btn btn-outline-secondary btn-sm" onClick="runButton()" value="실행" />
        <input id="button" type="button" class="btn btn-outline-secondary btn-sm" onClick="clear_result();"
          value="결과 지우기" />
        <input id="button" type="button" class="btn btn-outline-secondary btn-sm" onClick="file_save();" value="코드저장" />
      </div>
    </div>

    <div class="row" style="height: 90vh;">
      <div id="blocklyDiv" class="col-md-6"></div>
      <!-- code mirror -->
      <div class="col-md-6">
        <div style="position: relative;">
          <dive id="jsCodeEditor"></dive>
          <dive id="pyCodeEditor"></dive>
        </div>
        </textarea>
        <textarea id="exeArea" class="form-control" readonly style="height: 180px;"></textarea>
      </div>
    </div>

    <input id="btn_canvas" type="button" class="btn btn-outline-secondary btn-sm" onClick="canvas_power();"
      value="그림판 활성화" />
    <a id="download" download="image.png"><button type="button" id="btn_save" class="btn btn-outline-secondary btn-sm"
        onClick="canvas_save()" style="visibility: hidden;">그림
        저장</button></a>
    <input type="file" id="btn_upload" name="btn_upload" style="display: none;" />
    <div class="row">
      <!-- canvas -->
      <canvas id="canvas" class="canvas" width="500" height="500" style="display: none;">
      </canvas>
    </div>
  </div>

  <!-- Toolbox 정의 -->
  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" class="toolbox" style="display: none">
    <category name="논리" colour="%{BKY_LOGIC_HUE}">
      <block type="if_c"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="반복" colour="%{BKY_LOOPS_HUE}">
      <block type="for_c"></block>
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="연산" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2">
        <value name="X">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="Y">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="문자" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <!-- <block type="textc"></block> -->
      <block type="printc"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="배열" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
    </category>
    <category name="색상" colour=" %{BKY_COLOUR_HUE}">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb">
        <value name="RED">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="GREEN">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="BLUE">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="colour_blend">
        <value name="COLOUR1">
          <shadow type="colour_picker">
            <field name="COLOUR">#ff0000</field>
          </shadow>
        </value>
        <value name="COLOUR2">
          <shadow type="colour_picker">
            <field name="COLOUR">#3333ff</field>
          </shadow>
        </value>
        <value name="RATIO">
          <shadow type="math_number">
            <field name="NUM">0.5</field>
          </shadow>
        </value>
      </block>
    </category>

    <!-- 커스텀 블록 -->
    <sep></sep>
    <category name="변수" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
    <category name="함수" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE">
      <block type="async"></block>

    </category>
    <sep></sep>
    <!-- <category name="Linear Regression">
       <block type="np_array"></block>
       <block type="sequential"></block>
       <block type="dense"></block>
       <block type="compile"></block>
       <block type="fit"></block>
       <block type="prediction"></block>
     </category>
 
     <category name="Logistic Regression">
       <block type="load_x_data"></block>
       <block type="load_y_data"></block>
       <block type="split_data"></block>
       <block type="show_shape"></block>
       <block type="sequential"></block>
       <block type="evaluate"></block>
       <block type="dense"></block>
       <block type="compile"></block>
       <block type="fit"></block>
       <block type="prediction"></block>
     </category>-->

    <!--2020-07-02-->
    <!--<category name="Emotion" colour="%{BKY_VARIABLES_HUE}">-->
    <!-- Lee Jin Hyung -->
    <!--
       <block type="readcsv"></block>
       <block type="token"></block>
       <block type="tokenfit"></block>
       <block type="tokensquences"></block>
       <block type="wordindex"></block>
       <block type="padsequences"></block>
       <block type="separate"></block>
       <block type="keras_embedding"></block>
       <block type="keras_lstm"></block>
       <block type="keras_dropout"></block>-->
    <!-- Jo Cheon Woo -->
    <!--<block type="array_change"></block>
       <block type="onehotencoder"></block>
       <block type="onehotencoder_fit"></block>
       <block type="enc_transform"></block>
       <block type="model_predict"></block>
       <block type="enc_inverse"></block>-->

    <!--tensorji 선형회귀-->
    <!-- <category name="선형회귀" colour="%{BKY_VARIABLES_HUE}">
       <block type="callback"></block>
       <block type="sequential"></block>
       <block type="dense"></block>
       <block type="compile"></block>
       <block type="fit"></block>
       <block type="predict"></block>
       <block type="list"></block>
     </category>
     <category name="손글씨 예측" colour="%{BKY_VARIABLES_HUE}">
       <block type="csv"></block>
       <block type="callback"></block>
       <block type="async"></block>
       <block type="data"></block>
       <block type="sequential"></block> 
       <block type="add"></block>
       <block type="addn"></block>
       <block type="compile"></block>
       <block type="fit"></block>
       <block type="console"></block>
       <block type="feturelenght"></block>
       <block type="predict"></block>
       <block type="covid"></block>
       <block type="aaaa"></block>
     </category> 
     <category name="prolog" colour="%{BKY_VARIABLES_HUE}">
       <block type="prolog_list">
         <value name="bar">
           <block type="funktor"></block>
         </value>
       </block>
       <block type="Rule">
         <value name="Fact">
           <block type="prolog_list_rule">
             <value name="bar">
               <block type="funktor"></block>
             </value>
           </block>
         </value>
         <value name="Rumpf">
           <block type="rumpf"></block>
         </value>
       </block>
       <block type="abfrage">
         <value name="NAME">
           <block type="separate"></block>
         </value>
       </block>
       <block type="separate"></block>
       <block type="constant"></block>
       <block type="funktor"></block>
       <block type="rumpf"></block> -->


    <!-- </category> -->
    <!-- 크롤링 -->
    <!-- <category name="크롤링" colour="%{BKY_LOGIC_HUE}"> -->
    <!-- <block type="user_script"></block> -->
    <!-- <block type="script"></block> -->
    <!-- </category> -->
    <!-- 크롤링 -->


    <!-- <category name="데이터 전처리" colour="%{BKY_VARIABLES_HUE}"> -->
    <!-- <block type="file_upload"></block> -->
    <!-- </category> -->


    <!--numjs-->
    <category name="수치배열" colour="%{BKY_LOGIC_HUE}">
      <block type="nj_array"></block>
      <block type="nj_sum"></block>
      <block type="nj_multiply"></block>
      <block type="nj_substract"></block>
      <block type="nj_add"></block>
      <block type="nj_divide"></block>
      <block type="nj_shape"></block>

    </category>
    <category name="머신러닝" colour="%{BKY_LOGIC_HUE}">
      <category name="머신러닝 모델">
        <block type="sequential"></block>
        <block type="add"></block>
        <block type="addn"></block>
        <block type="compile"></block>
        <block type="fit"></block>
        <block type="csv"></block>
        <block type="csv2"></block>


      </category>
      <category name="선형회귀">
        <category name="단순 선형회귀 연산">
          <block type="js_hypothesis"></block>
          <block type="js_cost"></block>
          <block type="js_gradient_w"></block>
          <block type="js_gradient_b"></block>
        </category>
        <category name="다중 선형회귀 연산">
          <block type="mlrhypothesis"></block>
          <block type="mrlcost"></block>
          <block type="mrlwgradient"></block>
          <block type="mrlbgradient"></block>

        </category>
        <category name="선형회귀 그래프">
          <block type="lrgraph"></block>
        </category>

      </category>
      <category name="로지스틱회귀">
      </category>
    </category>
  </xml>

  </xml>
  <!-- code mirror -->
  <script>
    var jsEditor = CodeMirror(document.getElementById("jsCodeEditor"), {
      mode: "javascript",
      //   value: "codemirror",
      theme: "oceanic-next",
      inputStyle: "contenteditable",
      // readOnly: true,
      lineNumbers: true,
      extraKeys: {
        "Ctrl-Space": "autocomplete"
      },
      //   spellcheck: true,   autocorrect: true,
    });

    var pyEditor = CodeMirror(document.getElementById("pyCodeEditor"), {
      mode: "python",
      //   value: "codemirror",
      theme: "oceanic-next",
      inputStyle: "contenteditable",
      // readOnly: true,
      lineNumbers: true,
      extraKeys: {
        "Ctrl-Space": "autocomplete"
      },
      //   spellcheck: true,   autocorrect: true,
    });
  </script>
  <script id="jsScript" type="application/javascript">
    // var codeArea = document.getElementById("textArea"); // 코드 나타나는 부분 
    var codeArea = jsEditor.getValue();

    var demoWorkspace = Blockly.inject(                 // 블록이 나타나는 부분 
      "blocklyDiv",
      {
        toolbox: document.getElementById("toolbox"),    // 툴박스  보이기 
        grid:                                           // 그리드 보이기 
        {
          spacing: 0,
          length: 3,
          colour: '#ccc',
          snap: true
        },
        zoom:                                           // 줌 기능 
        {
          controls: true,
          wheel: true,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2
        },
        trashcan: true,                                  // 휴지통
        /*theme: {
          'blockStyles': {
            "list_blocks": {
              "colourPrimary": "#4a148c",
              "colourSecondary": "#AD7BE9",
              "colourTertiary": "#CDB6E9"
            }
          },
          'categoryStyles': {
            "list_category": {
              "colour": "#4a148c"
            }
          },
          'componentStyles': {
            'toolboxBackgroundColour': '#848484', // toolbox background
            'toolboxForegroundColour': '#fff',
            'flyoutBackgroundColour': '#D8D8D8', // toolbox color
          }
        }*/
      }
    );

    // 생성될 코드에 대해 선택하는 부분       
    var jsCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);   // 자바 스크립트 선택 
    // var pyCode = Blockly.Python.workspaceToCode(demoWorkspace);     // 파이썬 선택 

    var delCount = 0;
    var fileState = 0;
    var fileName = "";

    // ==================================
    // 블록 저장하기 
    //===================================  
    function saveBlock() {
      var xml = Blockly.Xml.workspaceToDom(demoWorkspace);
      var p_xml = Blockly.Xml.domToPrettyText(xml);
      var fileObject = new File([p_xml], "blocks.xml");
      saveAs(fileObject);
    }

    // ==================================
    // 블록 불러오기 
    //===================================  
    function loadBlock() {
      var reader = new FileReader();
      var files = document.getElementById("file").files;
      var file = files[0];
      if (file) {
        reader.onload = function (e) {
          var xml = reader.result;
          var dom = Blockly.Xml.textToDom(xml);
          Blockly.Xml.appendDomToWorkspace(dom, demoWorkspace);
          fileName = file.name;
          var jsCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);
          jsEditor.getValue() = jsCode;
          try {
            var pyCode = Blockly.Python.workspaceToCode(demoWorkspace);
            pyEditor.setValue(pyCode);
          } catch (e) {
            console.log('Python 코드가 매핑되어 있지 않습니다. Error : ' + e);
          }
        };
        reader.readAsText(file);
      }
    }

    // ==================================
    // 코드 갱신하기 
    //===================================  
    function codeUpdate(event) {
      var jsCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      jsEditor.setValue(jsCode);
      try {
        var pyCode = Blockly.Python.workspaceToCode(demoWorkspace);
        pyEditor.setValue(pyCode);
      } catch (e) {
        console.log('Python 코드가 매핑되어 있지 않습니다. Error : ' + e);
      }
    }

    // ==================================
    // 결과 지우기 
    //===================================  
    function clear_result() {
      document.getElementById("exeArea").value = "";
    }

    // ==================================
    // 파일로 저장하기 
    //===================================  
    function file_save() {
      var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      //var code = Blockly.Python.workspaceToCode(demoWorkspace);
      var blobObject = new Blob([code]);
      saveAs(blobObject, "download.js");
      //saveAs(blobObject, "download.py");
    }

    // ==================================
    // 블록을 선택했을 때 
    //=================================== 
    function whenSelected(event) {
      if (event.type == Blockly.Events.CREATE) {
        var block = demoWorkspace.getBlockById(event.blockId);
        console.log('블록이 선택됨1');
      }
      if (event.type == Blockly.Events.UI && event.element === "click") {
        var block = demoWorkspace.getBlockById(event.blockId);
        if ('csv' == block.type) {
          openTextFile(event.blockId);
        }
      }
    }
    demoWorkspace.addChangeListener(codeUpdate);
    demoWorkspace.addChangeListener(whenSelected);
  </script>

  <!-- ==================================
  ====== 블록 실행
  ===================================-->
  <script>
    function runButton() {
      Blockly.JavaScript.addReservedWords('code');
      var code = jsEditor.getValue();
      try {
        document.getElementById('exeArea').innerHTML = eval(code);
      } catch (e) {
        document.getElementById('exeArea').innerHTML = e;
      }
    };
    function openTextFile(blockId) {
      var input = document.createElement("input");
      input.type = "file";
      input.accept = ".csv"; // 확장자가 xxx, yyy 일때, ".xxx, .yyy"
      input.onchange = function (e) {
        $("#tblshow").empty();
        $("#tblhead").empty();
        ///////////////////////////////////////////
        var fileArray = new Array(); // csv to json?
        if (e.target.files != undefined) {
          var reader = new FileReader();
          reader.onload = function (e) {
            var csvval = e.target.result.split("\n");
            var csvvalue = csvval[0].split(",");
            var inputrad = "";
            // csv view! header 
            var objRow = document.all["tblhead"].insertRow();
            for (var i = 0; i < csvvalue.length; i++) {
              var temp = csvvalue[i];
              var objCell = objRow.insertCell();
              objCell.innerHTML = "<th>" + temp + "</th>";
              // dropdown append
              addOptions(temp);
            }
            csvval[0] = csvval[0].replace('\r', '');
            // row
            var cnt = (csvval.length < 2000) ? csvval.length : 2000;
            for (var i = 1; i < cnt; i++) {
              csvval[i] = csvval[i].replace('\r', '');
              var cols = csvval[i].split(',');
              var fileObject = new Object();
              var temp = csvval[i];
              var objRow = document.all["tblhead"].insertRow(); // csv view! 
              for (var j = 0; j < cols.length; j++) {
                var value = cols[j];
                var name = csvval[0].split(',')[j] // hedaer name
                var objCell = objRow.insertCell(); // csv view! 
                objCell.innerHTML = "<td>" + value + "</td>"; // csv view! 
                fileObject[name] = value; // value
              }
              fileArray.push(fileObject);
            }
            // 파일 set
            var block = demoWorkspace.getBlockById(blockId);
            var bId = Blockly.mainWorkspace.getBlockById(blockId)
            block.setFieldValue(JSON.stringify(fileArray), 'csv_url'); // csv_url -> field_input ID
          };
          reader.readAsText(e.target.files.item(0));
        }
        sessionStorage.setItem('csv_data', JSON.stringify(fileArray));
        // var tmp = JSON.parse(sessionStorage.getItem('csv_data'));
        // // map
        // var x = tmp.map(s => s.x);
      };

      input.click();
    }
    function addToolboxButtonCallbacks() {
      workspace.registerButtonCallback(
        'addDynamicOption', Blockly.TestBlocks.addDynamicDropdownOption_);
      workspace.registerButtonCallback(
        'removeDynamicOption', Blockly.TestBlocks.removeDynamicDropdownOption_);
    }

    function processFile(file) {
      var reader = new FileReader();
      reader.onload = function () {
        var fileResult = reader.result;
        var val = sessionStorage.setItem('file', fileResult);
      };
      reader.readAsText(file, /* optional */ "cp949");
    }

    /** 그래프 */
    const metrics = ['loss', 'val_loss', 'acc', 'val_acc']
    const container = {
      name: 'Model Training',
      styles: {
        height: '1000px'
      }
    };

    async function saveModel(model) {
      model.save('localstorage://my-model');
      alert('완료되었습니다.');
    }

    // canvas 활성화 & 비활성화
    function canvas_power() {
      var canvasState = $("#canvas")[0];
      var btnSave = $("#btn_save")[0];
      if (canvasState.style.display == "" || canvasState.style.display == "none") {
        canvasState.style.display = "block";
        $("#btn_save")[0].style.visibility = "visible";
        $("#btn_canvas").val("그림판 비활성화");
      } else {
        canvasState.style.display = "none";
        $("#btn_save")[0].style.visibility = "hidden";
        $("#btn_canvas").val("그림판 활성화");
      }
    }

    const alphaPixel = []
    function canvas_save() {
      var download = $("#download")[0];
      var canvas = $("#canvas")[0];
      var c = document.getElementById("canvas");
      var ctx = c.getContext("2d");
      console.log(ctx);
      var pixel = ctx.getImageData(0, 0, 28, 28).data;
      for (i = 3, idx = 0; i < pixel.length; i += 4) {
        alphaPixel[idx] = pixel[i];
        idx++;
      }
      console.log(alphaPixel);
    }
    /*
    * 코드미러 화면 전환(python&javascript)
    */
    $("#display_select").change(function () {
      var selectName = $(this).find(":selected").val();
      var pyEditor = $("#pyCodeEditor");
      var jsEditor = $("#jsCodeEditor");

      if (selectName == "javascript") {
        jsEditor.css("visibility", "visible");
        pyEditor.css("visibility", "hidden");
      } else if (selectName == "python") {
        pyEditor.css("visibility", "visible");
        jsEditor.css("visibility", "hidden");
      }
    });

    //사이드바
    $(function () {
      var duration = 300;

      var $side = $('#sidebar');
      var $sidebt = $side.find('button').on('click', function () {
        $side.toggleClass('open');

        if ($side.hasClass('open')) {
          $side.stop(true).animate({ right: '0px' }, duration);
          $sidebt.find('span').text('X');
        } else {
          $side.stop(true).animate({ right: '-900px' }, duration);
          $sidebt.find('span').text('그래프');
        };
      });
    });

    // TESTER = document.getElementById('graph1');
    // Plotly.newPlot(TESTER, [{
    //   x: [1, 2, 3, 4, 5],
    //   y: [1, 2, 4, 8, 16]
    // }], {
    //   margin: { t: 0 }
    // });
    // TESTER = document.getElementById('graph2');
    // Plotly.newPlot(TESTER, [{
    //   x: [1, 2, 3, 4, 5],
    //   y: [1, 2, 4, 8, 16]
    // }], {
    //   margin: { t: 0 }
    // });
    // TESTER = document.getElementById('graph3');
    // Plotly.newPlot(TESTER, [{
    //   x: [1, 2, 3, 4, 5],
    //   y: [1, 2, 4, 8, 16]
    // }], {
    //   margin: { t: 0 }
    // });


    ///화면에 찍기 프린트
    function printc(x) {
      var savetext = $('#exeArea').val();
      $('#exeArea').val(savetext + x + '\n');
    }

    //선형회귀 그래프
    function LRgraph(x, y, w, b) {
      var xa = new Array();
      var ya = new Array();
      var ba = new Array();
      for (var i = 0; i < x.shape; i++) {
        xa.push(x.get(i));
        ya.push(y.get(i));
        pred = (x.get(i) * w + b)
        ba.push(pred);
      }
      var data = {
        x: xa,
        y: ya,
        mode: 'markers',
        type: 'scatter',
        name: 'data'
      };

      var prediction = {
        x: xa,
        y: ba,
        mode: 'lines',
        type: 'scatter',
        name: 'prediction'
      }; var layout = {
        autosize: true

      };
      var layout = {
        autosize: true
      };

      var datax = [data, prediction];

      Plotly.newPlot('graph', datax, layout);
    }
  </script>
  <script src="/js/utils/canvas.js"></script> <!-- 그림판 -->
</body>

</html>